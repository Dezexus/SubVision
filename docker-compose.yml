# Версия синтаксиса docker-compose.
# Рекомендуется использовать '3.8' или выше для поддержки всех современных функций.
version: '3.8'

# Определение сервисов (контейнеров), которые будут запущены.
services:
  # Имя сервиса, в данном случае 'subvision'.
  subvision:
    # Указывает, что образ для этого сервиса должен быть собран
    # с использованием Dockerfile, находящегося в текущей директории ('.').
    build: .
    # Задает кастомное имя для контейнера, чтобы его было легче идентифицировать.
    container_name: subvision_app
    # Проброс портов. Связывает порт 7860 на хост-машине с портом 7860 внутри контейнера,
    # делая веб-интерфейс Gradio доступным по адресу http://localhost:7860.
    ports:
      - "7860:7860"
    # Монтирование томов (volumes) для сохранения данных между перезапусками контейнера.
    # Это используется для кэширования моделей, чтобы не скачивать их каждый раз.
    volumes:
      # Связывает локальную папку './hf_cache' с папкой '/app/hf_cache' в контейнере (для моделей Hugging Face).
      - ./hf_cache:/app/hf_cache
      # Связывает локальную папку './paddle_cache' с папкой '/app/paddle_cache' в контейнере (для моделей Paddle).
      - ./paddle_cache:/app/paddle_cache
    # Конфигурация для развертывания в Docker Swarm, также используется для выделения ресурсов.
    deploy:
      resources:
        # Резервирование ресурсов для контейнера.
        reservations:
          # Запрос доступа к GPU от хост-машины.
          devices:
            - driver: nvidia       # Указывает, что нужен драйвер NVIDIA.
              count: 1             # Запрашивает одно GPU-устройство.
              capabilities: [gpu]  # Указывает, что требуется именно GPU.
    # Переменные окружения, которые будут доступны внутри контейнера.
    environment:
      # Делает все GPU-устройства NVIDIA видимыми для контейнера.
      - NVIDIA_VISIBLE_DEVICES=all
      # Отключает проверку источника моделей, что может быть полезно
      # при работе в изолированных средах или с кастомными моделями.
      - DISABLE_MODEL_SOURCE_CHECK=1
      - PADDLE_PDX_DISABLE_MODEL_SOURCE_CHECK=1
    # Оставляет stdin открытым, что позволяет взаимодействовать с контейнером.
    stdin_open: true
    # Выделяет псевдо-TTY, что позволяет запускать интерактивные сессии в контейнере.
    tty: true
    # Политика перезапуска контейнера.
    # 'unless-stopped' означает, что контейнер будет автоматически перезапущен
    # после сбоя или перезагрузки хоста, но не если он был остановлен вручную.
    restart: unless-stopped
